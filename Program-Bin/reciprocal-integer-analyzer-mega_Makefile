# Makefile for Reciprocal Integer Analyzer - Mega Edition (10^50 Recursions)
# ================================================================

CXX = g++
CXXFLAGS = -std=c++17 -O3 -pthread -march=native -mtune=native
INCLUDES = -I/usr/local/include -I/usr/include
LIBS = -lboost_system -lboost_thread -lboost_math -lboost_multiprecision -lpthread

# Source files
SOURCES = reciprocal-integer-analyzer-mega.cpp
TARGET = reciprocal-analyzer-mega
OBJECTS = $(SOURCES:.cpp=.o)

# Default target
all: $(TARGET)

# Build the main executable
$(TARGET): $(OBJECTS)
	$(CXX) $(CXXFLAGS) -o $(TARGET) $(OBJECTS) $(LDFLAGS)

# Compile source files
%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Install dependencies (Ubuntu/Debian)
install-deps:
	sudo apt-get update
	sudo apt-get install -y libboost-all-dev build-essential g++ pkg-config

# Test with small sample
test-small: $(TARGET)
	./$(TARGET)

# Test with mega sweep (1000 entries)
test-mega: $(TARGET)
	./$(TARGET) --mega-sweep 1000 log

# Test with extreme sweep (1 million entries)
test-extreme: $(TARGET)
	./$(TARGET) --mega-sweep 1000000 log

# Production run for 10^50 scale verification
production: $(TARGET)
	./$(TARGET) --mega-sweep 10000000 log

# Clean build artifacts
clean:
	rm -f $(OBJECTS) $(TARGET) reciprocal_analysis_output.txt reciprocal_analysis_output.txt.progress

# Clean everything including outputs
clean-all: clean
	rm -f *.txt *.progress *.log

# Check if required libraries are available
check-deps:
	@echo "Checking for required libraries..."
	@pkg-config --exists boost_system && echo "✓ boost_system found" || echo "✗ boost_system missing"
	@pkg-config --exists boost_thread && echo "✓ boost_thread found" || echo "✗ boost_thread missing"
	@g++ --version | head -1
	@echo "Build system ready!"

# Performance profiling
profile: $(TARGET)
	perf record -g ./$(TARGET) --mega-sweep 10000 log
	perf report

# Memory usage check
memcheck: $(TARGET)
	valgrind --tool=massif ./$(TARGET) --mega-sweep 1000 log
	ms_print massif.out.*

# Help target
help:
	@echo "Available targets:"
	@echo "  all           - Build the program"
	@echo "  install-deps  - Install required dependencies"
	@echo "  test-small    - Run with small test dataset"
	@echo "  test-mega     - Run with 1000 entries"
	@echo "  test-extreme  - Run with 1 million entries"
	@echo "  production    - Run production scale (10 million entries)"
	@echo "  clean         - Clean build artifacts"
	@echo "  clean-all     - Clean everything including outputs"
	@echo "  check-deps    - Check if dependencies are available"
	@echo "  profile       - Run with performance profiling"
	@echo "  memcheck      - Check for memory leaks"
	@echo "  help          - Show this help"

.PHONY: all install-deps test-small test-mega test-extreme production clean clean-all check-deps profile memcheck help